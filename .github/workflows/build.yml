name: build-and-deploy

on:
  schedule:
    - cron: '0 3 * * *'
  workflow_dispatch:
    inputs:
      limit:
        description: 'Number of papers to process'
        required: false
        default: '5'

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: read
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
      - name: Run tests
        run: pytest -q
      - name: Build site
        env:
          OPENROUTER_API_KEY: ${{ secrets.OPENROUTER_API_KEY }}
          DISCORD_WEBHOOK_URL: ${{ secrets.DISCORD_WEBHOOK_URL }}
        run: |
          # Harvest from Internet Archive
          python -m src.harvest_ia --limit ${{ inputs.limit || 5 }} || true
          
          # Find latest records
          latest=$(ls -1t data/records/ia_*.json 2>/dev/null | head -n1 || echo '')
          if [ -n "$latest" ]; then
            python -m src.select_and_fetch --records "$latest" --limit ${{ inputs.limit || 5 }} --output data/selected.json || true
          else
            echo '[]' > data/selected.json
          fi
          
          # Translate
          python -m src.pipeline --limit ${{ inputs.limit || 5 }} || true
          
          # Render site
          python -m src.render
          python -m src.search_index
          python -m src.make_pdf || true
      - name: Deploy to Cloudflare Pages
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CF_API_TOKEN }}
        run: |
          npm install -g wrangler
          wrangler pages deploy site --project-name chinaxiv-english
