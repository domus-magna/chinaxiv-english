name: build-and-deploy

on:
  schedule:
    - cron: '0 3 * * *'
  workflow_dispatch:
    inputs:
      limit:
        description: 'Number of papers to process'
        required: false
        default: '5'

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: read
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
      - name: Run tests
        run: pytest -q
      - name: Build site
        env:
          OPENROUTER_API_KEY: ${{ secrets.OPENROUTER_API_KEY }}
          DISCORD_WEBHOOK_URL: ${{ secrets.DISCORD_WEBHOOK_URL }}
        run: |
          set -e
          echo "ğŸš€ Starting build process..."
          
          # Harvest from Internet Archive
          echo "ğŸ“¥ Harvesting from Internet Archive..."
          python -m src.harvest_ia --limit ${{ inputs.limit || 5 }} || {
            echo "âš ï¸ Harvest failed, continuing with existing data"
          }
          
          # Find latest records
          echo "ğŸ” Finding latest records..."
          latest=$(ls -1t data/records/ia_*.json 2>/dev/null | head -n1 || echo '')
          if [ -n "$latest" ]; then
            echo "ğŸ“‹ Processing records from: $latest"
            python -m src.select_and_fetch --records "$latest" --limit ${{ inputs.limit || 5 }} --output data/selected.json || {
              echo "âš ï¸ Record selection failed, using empty selection"
              echo '[]' > data/selected.json
            }
          else
            echo "âš ï¸ No records found, using empty selection"
            echo '[]' > data/selected.json
          fi
          
          # Translate
          echo "ğŸŒ Running translation pipeline..."
          python -m src.pipeline --limit ${{ inputs.limit || 5 }} || {
            echo "âš ï¸ Translation failed, continuing with existing translations"
          }
          
          # Render site
          echo "ğŸ¨ Rendering site..."
          python -m src.render || {
            echo "âŒ Site rendering failed"
            exit 1
          }
          
          echo "ğŸ” Building search index..."
          python -m src.search_index || {
            echo "âŒ Search index failed"
            exit 1
          }
          
          echo "ğŸ“„ Generating PDFs..."
          python -m src.make_pdf || {
            echo "âš ï¸ PDF generation failed, continuing without PDFs"
          }
          
          echo "âœ… Build completed successfully!"
      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
      - name: Deploy to Cloudflare Pages
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CF_API_TOKEN }}
        run: |
          set -e
          echo "ğŸš€ Deploying to Cloudflare Pages..."
          
          echo "ğŸ“¦ Installing Wrangler CLI..."
          npm install -g wrangler || {
            echo "âŒ Failed to install Wrangler"
            exit 1
          }
          
          echo "ğŸŒ Deploying site..."
          wrangler pages deploy site --project-name chinaxiv-english || {
            echo "âŒ Deployment failed"
            exit 1
          }
          
          echo "âœ… Deployment completed successfully!"
