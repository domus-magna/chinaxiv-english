{% extends "base.html" %}
{% block header_breadcrumbs %}
  <div class="header-breadcrumbs">
    <a href="{{ root }}/">Home</a> <span class="sep">&gt;</span> ChinaXiv {{ item.id }}
  </div>
{% endblock %}
{% block content %}
  <article class="paper">
    <div class="paper-layout">
      <div class="paper-main">
        {# Subject classification line, arXiv-style #}
        {% set _subjects = (item.subjects_en if item.subjects_en else (item.subjects if item.subjects else [])) %}
        {% if _subjects and (_subjects|length) > 0 %}
          <div class="subheader">
            <h1>{{ _subjects[0] }}</h1>
          </div>
        {% endif %}

        <div style="margin-bottom: 12px;">
          <span class="descriptor">Title:</span> {{ item.title_en }}
        </div>

        <div style="margin-bottom: 8px;">
          <span class="descriptor">Authors:</span> {{ ', '.join(item.creators_en or item.creators or ['Unknown']) }}
        </div>

        {# Dateline and quick meta #}
        <div class="meta">
          <span class="dateline">[Submitted on {{ item.date or 'N/A' }}]</span>
          {% if item.license and item.license.badge %}
            <span class="badge">{{ item.license.badge }}</span>
          {% endif %}
          {% if not item._has_full_text %}
            <span class="badge">Abstract only</span>
          {% endif %}
        </div>

        {# Cite-as line #}
        <div class="meta">
          <span class="descriptor">Cite as:</span> ChinaXiv: {{ item.id }}
        </div>

        {# Optional metadata table similar to arXiv (only shows present fields) #}
        <div class="meta-table" style="margin: 16px 0 8px;">
          <dl>
            {% if _subjects and (_subjects|length) > 0 %}
              <dt>Subjects:</dt>
              <dd>{{ ', '.join(_subjects) }}</dd>
            {% endif %}
            {% if item.doi %}
              <dt>DOI:</dt>
              <dd><a href="https://doi.org/{{ item.doi }}" target="_blank" rel="noopener">{{ item.doi }}</a></dd>
            {% endif %}
            {% if item.journal_ref %}
              <dt>Journal ref:</dt>
              <dd>{{ item.journal_ref }}</dd>
            {% endif %}
            {% if item.comments %}
              <dt>Comments:</dt>
              <dd>{{ item.comments }}</dd>
            {% endif %}
            {% if item.report_num %}
              <dt>Report number:</dt>
              <dd>{{ item.report_num }}</dd>
            {% endif %}
          </dl>
        </div>

        <h2>Abstract</h2>
        <div class="abstract-blockquote">
          {{ (item.abstract_md or item.abstract_en) | markdown | safe }}
        </div>

        {% if item._has_full_text and item.formatted_body_md %}
          <h2>Full Text</h2>
          <div class="full-text-preview">
            {{ item.formatted_body_md | markdown | safe }}
          </div>
        {% elif item._has_full_text and item.body_en %}
          <h2>Full Text</h2>
          <div class="full-text-preview">
            {% for p in item.body_en %}
              <p>{{ p }}</p>
            {% endfor %}
          </div>
        {% endif %}

        <div class="source">
          <a href="{{ item.source_url }}" target="_blank" rel="noopener">View original on ChinaXiv</a>
        </div>

        {# Submission history (single entry, we do not have versions) #}
        <div class="submission-history">
          <h2>Submission history</h2>
          <div class="dateline">[v1] {{ item.date or 'N/A' }}</div>
        </div>
      </div>

      <div class="paper-sidebar">
        <div class="sidebar-section">
          <h3>{% if item._has_full_text %}Access Paper{% else %}Access Abstract{% endif %}</h3>
          {% if not item._has_full_text %}
          <div class="banner" role="status">This record includes the abstract only. Full text is not available for this paper.</div>
          {% endif %}
          <ul class="sidebar-actions">
            {% if item.pdf_url %}
            <li><a href="{{ item.pdf_url }}" class="sidebar-btn primary" target="_blank" rel="noopener" aria-label="Open original PDF on ChinaXiv">{% if item._has_full_text %}Download PDF{% else %}Original PDF (ChinaXiv){% endif %}</a></li>
            {% endif %}
            <li><a href="{{ '/items/' ~ item.id ~ '/' ~ item.id ~ '.md' }}" class="sidebar-btn" aria-label="View Markdown version">{% if item._has_full_text %}View Markdown{% else %}View Abstract (MD){% endif %}</a></li>
            {% if item._has_full_text %}
            <li><a href="{{ '/items/' ~ item.id ~ '/' ~ item.id ~ '.pdf' }}" class="sidebar-btn" aria-label="Download full text PDF">Full Text PDF</a></li>
            {% endif %}
          </ul>
        </div>

        <div class="sidebar-section">
          <h3>Citation</h3>
          <ul class="sidebar-actions">
            <li><a href="#" class="sidebar-btn" onclick="copyCitation()" aria-label="Copy citation to clipboard">Copy Citation</a></li>
            <li><a href="#" class="sidebar-btn" onclick="exportBibTeX()" aria-label="Export BibTeX citation">Export BibTeX</a></li>
          </ul>
        </div>

        <div class="sidebar-section">
          <h3>Share</h3>
          <ul class="sidebar-actions">
            <li><a href="#" class="sidebar-btn" onclick="sharePaper()" aria-label="Share this paper">Share Paper</a></li>
            <li><a href="#" class="sidebar-btn" onclick="bookmarkPaper()" aria-label="Bookmark this paper">Bookmark</a></li>
          </ul>
        </div>

        <div class="sidebar-section">
          <h3>Related</h3>
          <ul class="sidebar-actions">
            <li><a href="{{ root }}/" class="sidebar-btn" aria-label="Browse more papers">Browse More Papers</a></li>
            {% set _first_subject = (_subjects[0] | lower) if (_subjects and (_subjects|length) > 0) else 'all' %}
            <li><a href="{{ root }}/?category={{ _first_subject }}" class="sidebar-btn" aria-label="See similar papers">Similar Papers</a></li>
          </ul>
        </div>
      </div>
    </div>
  </article>

  <script>
    // Clipboard helper with fallback
    function copyToClipboard(text, successMessage) {
      if (navigator.clipboard && window.isSecureContext) {
        navigator.clipboard.writeText(text).then(() => {
          alert(successMessage);
        }).catch(() => {
          fallbackCopyToClipboard(text, successMessage);
        });
      } else {
        fallbackCopyToClipboard(text, successMessage);
      }
    }

    function fallbackCopyToClipboard(text, successMessage) {
      const textArea = document.createElement('textarea');
      textArea.value = text;
      textArea.style.position = 'fixed';
      textArea.style.left = '-999999px';
      textArea.style.top = '-999999px';
      document.body.appendChild(textArea);
      textArea.focus();
      textArea.select();
      
      try {
        document.execCommand('copy');
        alert(successMessage);
      } catch (err) {
        console.error('Failed to copy text: ', err);
        alert('Failed to copy to clipboard');
      }
      
      document.body.removeChild(textArea);
    }

    function copyCitation() {
      const citation = `{{ (item.creators_en or item.creators)[0] if (item.creators_en or item.creators) else 'Unknown' }} ({{ item.date[:4] if item.date else 'N/A' }}). {{ item.title_en }}. ChinaXiv: {{ item.id }}.`;
      copyToClipboard(citation, 'Citation copied to clipboard!');
    }

    function escapeBibTeX(s) {
      return (s || '').replace(/[{}\\]/g, '\\$&');
    }

    function exportBibTeX() {
      const title = escapeBibTeX({{ item.title_en|tojson }});
      const authors = escapeBibTeX({{ ', '.join(item.creators_en or item.creators or ['Unknown'])|tojson }});
      const year = {{ item.date[:4] if item.date else 'N/A'|tojson }};
      const url = escapeBibTeX({{ item.source_url|tojson }});
      // Replace dots and hyphens with underscores for valid BibTeX ID
      const id = {{ item.id|tojson }}.replace(/[.-]/g, '_');
      
      const bibtex = `@article{chinaxiv${id},
  title={${title}},
  author={${authors}},
  journal={ChinaXiv},
  year={${year}},
  url={${url}}
}`;
      copyToClipboard(bibtex, 'BibTeX citation copied to clipboard!');
    }

    function sharePaper() {
      if (navigator.share) {
        try {
          navigator.share({
            title: {{ item.title_en|tojson }},
            text: 'Check out this paper from ChinaXiv Translations',
            url: window.location.href
          }).catch(() => {
            copyToClipboard(window.location.href, 'Paper URL copied to clipboard!');
          });
        } catch (e) {
          copyToClipboard(window.location.href, 'Paper URL copied to clipboard!');
        }
      } else {
        copyToClipboard(window.location.href, 'Paper URL copied to clipboard!');
      }
    }

    function bookmarkPaper() {
      try {
        const bookmarks = JSON.parse(localStorage.getItem('chinaxiv_bookmarks') || '[]');
        const bookmark = {
          id: {{ item.id|tojson }},
          title: {{ item.title_en|tojson }},
          url: window.location.href,
          date: new Date().toISOString()
        };
        if (!bookmarks.find(b => b.id === bookmark.id)) {
          bookmarks.push(bookmark);
          localStorage.setItem('chinaxiv_bookmarks', JSON.stringify(bookmarks));
          alert('Paper bookmarked!');
        } else {
          alert('Paper already bookmarked!');
        }
      } catch (e) {
        console.warn('Bookmarking unavailable', e);
        alert('Bookmarking is unavailable in this browser or context.');
      }
    }
  </script>
{% endblock %}
